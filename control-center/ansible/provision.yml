---
# =============================================================================
# PROVISION WORDPRESS FARM INFRASTRUCTURE ON DIGITALOCEAN
# =============================================================================
# This playbook provisions all infrastructure on DigitalOcean:
# - VPC network
# - SSH keys
# - Droplets (managers, workers, cache, database, storage, monitors)
# - Block storage volumes
# - Firewall rules
# - Tags for organization
#
# Usage:
#   ansible-playbook provision.yml
#   ansible-playbook provision.yml --tags managers
#   ansible-playbook provision.yml --tags workers,cache
#   ansible-playbook provision.yml --extra-vars "dry_run=true"
#
# Requirements:
#   - DO_API_TOKEN environment variable set
#   - doctl CLI installed and authenticated
#   - Ansible collections installed (see requirements.yml)
# =============================================================================

- name: Provision Infrastructure Prerequisites
  hosts: localhost
  gather_facts: false
  tags: [always, prerequisites]
  
  tasks:
    - name: Check required environment variables
      assert:
        that:
          - do_api_token is defined
          - do_api_token | length > 0
        fail_msg: "DO_API_TOKEN must be set. Export it or add to .env file."
    
    - name: Verify doctl is installed
      command: doctl version
      register: doctl_check
      changed_when: false
      failed_when: false
    
    - name: Display doctl version
      debug:
        msg: "doctl version: {{ doctl_check.stdout }}"
      when: doctl_check.rc == 0
    
    - name: Check doctl authentication
      command: doctl auth list
      register: doctl_auth
      changed_when: false
      failed_when: doctl_auth.rc != 0


- name: Create VPC Network
  hosts: localhost
  gather_facts: false
  tags: [vpc, network]
  
  tasks:
    - name: Create VPC for WordPress Farm
      community.digitalocean.digital_ocean_vpc:
        state: present
        name: "{{ deployment_project }}-vpc"
        region: "{{ do_region }}"
        ip_range: "{{ vpc_cidr }}"
        oauth_token: "{{ do_api_token }}"
      register: vpc_result
    
    - name: Save VPC ID
      set_fact:
        vpc_id: "{{ vpc_result.data.vpc.id }}"
        cacheable: true
    
    - name: Display VPC information
      debug:
        msg:
          - "VPC Name: {{ vpc_result.data.vpc.name }}"
          - "VPC ID: {{ vpc_result.data.vpc.id }}"
          - "VPC CIDR: {{ vpc_result.data.vpc.ip_range }}"
          - "Region: {{ vpc_result.data.vpc.region }}"


- name: Setup SSH Keys
  hosts: localhost
  gather_facts: false
  tags: [ssh, keys]
  
  tasks:
    - name: Check if SSH key exists locally
      stat:
        path: "~/.ssh/{{ do_ssh_key_name }}"
      register: ssh_key_check
    
    - name: Generate SSH key if not exists
      openssh_keypair:
        path: "~/.ssh/{{ do_ssh_key_name }}"
        type: ed25519
        comment: "{{ do_ssh_key_name }}@wordpress-farm"
        state: present
      when: not ssh_key_check.stat.exists
    
    - name: Read public SSH key
      slurp:
        src: "~/.ssh/{{ do_ssh_key_name }}.pub"
      register: ssh_public_key
    
    - name: Upload SSH key to DigitalOcean
      community.digitalocean.digital_ocean_sshkey:
        state: present
        name: "{{ do_ssh_key_name }}"
        ssh_pub_key: "{{ ssh_public_key.content | b64decode }}"
        oauth_token: "{{ do_api_token }}"
      register: do_ssh_key
    
    - name: Save SSH key ID
      set_fact:
        ssh_key_id: "{{ do_ssh_key.data.ssh_key.id }}"
        cacheable: true


- name: Provision Manager Nodes
  hosts: localhost
  gather_facts: false
  tags: [managers, nodes]
  
  tasks:
    - name: Create manager droplets
      community.digitalocean.digital_ocean_droplet:
        state: present
        name: "wp-manager-{{ '%02d' | format(item) }}"
        size: "{{ manager_node_size }}"
        region: "{{ do_region }}"
        image: ubuntu-22-04-x64
        ssh_keys:
          - "{{ ssh_key_id }}"
        tags:
          - "{{ deployment_project }}"
          - manager
          - swarm-manager
        vpc_uuid: "{{ vpc_id }}"
        monitoring: true
        ipv6: false
        wait: true
        wait_timeout: 600
        unique_name: true
        oauth_token: "{{ do_api_token }}"
      loop: "{{ range(1, (manager_node_count | int) + 1) | list }}"
      register: manager_droplets
      async: 600
      poll: 0
    
    - name: Wait for manager droplet creation
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: manager_jobs
      until: manager_jobs.finished
      retries: 60
      delay: 10
      loop: "{{ manager_droplets.results }}"
    
    - name: Display created managers
      debug:
        msg: "Created manager: {{ item.droplet.name }} ({{ item.droplet.networks.v4[0].ip_address }})"
      loop: "{{ manager_jobs.results }}"
      when: item.droplet is defined


- name: Provision Worker Nodes
  hosts: localhost
  gather_facts: false
  tags: [workers, nodes]
  
  tasks:
    - name: Create worker droplets
      community.digitalocean.digital_ocean_droplet:
        state: present
        name: "wp-worker-{{ '%02d' | format(item) }}"
        size: "{{ worker_node_size }}"
        region: "{{ do_region }}"
        image: ubuntu-22-04-x64
        ssh_keys:
          - "{{ ssh_key_id }}"
        tags:
          - "{{ deployment_project }}"
          - worker
          - swarm-worker
        vpc_uuid: "{{ vpc_id }}"
        monitoring: true
        ipv6: false
        wait: true
        wait_timeout: 600
        unique_name: true
        oauth_token: "{{ do_api_token }}"
      loop: "{{ range(1, (worker_node_count | int) + 1) | list }}"
      register: worker_droplets
      async: 600
      poll: 0
    
    - name: Wait for worker droplet creation
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: worker_jobs
      until: worker_jobs.finished
      retries: 60
      delay: 10
      loop: "{{ worker_droplets.results }}"


- name: Provision Cache Nodes
  hosts: localhost
  gather_facts: false
  tags: [cache, nodes]
  
  tasks:
    - name: Create cache droplets
      community.digitalocean.digital_ocean_droplet:
        state: present
        name: "wp-cache-{{ '%02d' | format(item) }}"
        size: "{{ cache_node_size }}"
        region: "{{ do_region }}"
        image: ubuntu-22-04-x64
        ssh_keys:
          - "{{ ssh_key_id }}"
        tags:
          - "{{ deployment_project }}"
          - cache
          - swarm-worker
        vpc_uuid: "{{ vpc_id }}"
        monitoring: true
        ipv6: false
        wait: true
        wait_timeout: 600
        unique_name: true
        oauth_token: "{{ do_api_token }}"
      loop: "{{ range(1, (cache_node_count | int) + 1) | list }}"
      register: cache_droplets
      async: 600
      poll: 0
    
    - name: Wait for cache droplet creation
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: cache_jobs
      until: cache_jobs.finished
      retries: 60
      delay: 10
      loop: "{{ cache_droplets.results }}"


- name: Provision Database Nodes
  hosts: localhost
  gather_facts: false
  tags: [database, db, nodes]
  
  tasks:
    - name: Create database droplets
      community.digitalocean.digital_ocean_droplet:
        state: present
        name: "wp-db-{{ '%02d' | format(item) }}"
        size: "{{ database_node_size }}"
        region: "{{ do_region }}"
        image: ubuntu-22-04-x64
        ssh_keys:
          - "{{ ssh_key_id }}"
        tags:
          - "{{ deployment_project }}"
          - database
          - swarm-worker
        vpc_uuid: "{{ vpc_id }}"
        monitoring: true
        ipv6: false
        wait: true
        wait_timeout: 600
        unique_name: true
        oauth_token: "{{ do_api_token }}"
      loop: "{{ range(1, (database_node_count | int) + 1) | list }}"
      register: database_droplets
      async: 600
      poll: 0
    
    - name: Wait for database droplet creation
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: database_jobs
      until: database_jobs.finished
      retries: 60
      delay: 10
      loop: "{{ database_droplets.results }}"


- name: Provision Storage Nodes
  hosts: localhost
  gather_facts: false
  tags: [storage, nodes]
  
  tasks:
    - name: Create storage droplets
      community.digitalocean.digital_ocean_droplet:
        state: present
        name: "wp-storage-{{ '%02d' | format(item) }}"
        size: "{{ storage_node_size }}"
        region: "{{ do_region }}"
        image: ubuntu-22-04-x64
        ssh_keys:
          - "{{ ssh_key_id }}"
        tags:
          - "{{ deployment_project }}"
          - storage
          - swarm-worker
        vpc_uuid: "{{ vpc_id }}"
        monitoring: true
        ipv6: false
        wait: true
        wait_timeout: 600
        unique_name: true
        oauth_token: "{{ do_api_token }}"
      loop: "{{ range(1, (storage_node_count | int) + 1) | list }}"
      register: storage_droplets
      async: 600
      poll: 0
    
    - name: Wait for storage droplet creation
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: storage_jobs
      until: storage_jobs.finished
      retries: 60
      delay: 10
      loop: "{{ storage_droplets.results }}"
    
    - name: Create block storage volumes for storage nodes
      community.digitalocean.digital_ocean_block_storage:
        state: present
        command: create
        volume_name: "wp-storage-{{ '%02d' | format(item.item) }}-vol"
        region: "{{ do_region }}"
        block_size: "{{ storage_volume_size }}"
        oauth_token: "{{ do_api_token }}"
      loop: "{{ storage_jobs.results }}"
      register: storage_volumes
      when: item.droplet is defined
    
    - name: Attach volumes to storage droplets
      community.digitalocean.digital_ocean_block_storage:
        state: present
        command: attach
        volume_name: "{{ item.0.volume.name }}"
        region: "{{ do_region }}"
        droplet_id: "{{ item.1.droplet.id }}"
        oauth_token: "{{ do_api_token }}"
      loop: "{{ storage_volumes.results | zip(storage_jobs.results) | list }}"
      when:
        - item.0.volume is defined
        - item.1.droplet is defined


- name: Provision Monitor Nodes
  hosts: localhost
  gather_facts: false
  tags: [monitors, monitoring, nodes]
  
  tasks:
    - name: Create monitor droplets
      community.digitalocean.digital_ocean_droplet:
        state: present
        name: "wp-monitor-{{ '%02d' | format(item) }}"
        size: "{{ monitor_node_size }}"
        region: "{{ do_region }}"
        image: ubuntu-22-04-x64
        ssh_keys:
          - "{{ ssh_key_id }}"
        tags:
          - "{{ deployment_project }}"
          - monitor
          - ops
          - swarm-worker
        vpc_uuid: "{{ vpc_id }}"
        monitoring: true
        ipv6: false
        wait: true
        wait_timeout: 600
        unique_name: true
        oauth_token: "{{ do_api_token }}"
      loop: "{{ range(1, (monitor_node_count | int) + 1) | list }}"
      register: monitor_droplets
      async: 600
      poll: 0
    
    - name: Wait for monitor droplet creation
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: monitor_jobs
      until: monitor_jobs.finished
      retries: 60
      delay: 10
      loop: "{{ monitor_droplets.results }}"


- name: Provision Summary
  hosts: localhost
  gather_facts: false
  tags: [always]
  
  tasks:
    - name: Refresh dynamic inventory
      meta: refresh_inventory
    
    - name: Display provisioning summary
      debug:
        msg:
          - "========================================"
          - "WordPress Farm Infrastructure Provisioned"
          - "========================================"
          - "VPC: {{ deployment_project }}-vpc"
          - "Region: {{ do_region }}"
          - "Manager nodes: {{ manager_node_count }}"
          - "Worker nodes: {{ worker_node_count }}"
          - "Cache nodes: {{ cache_node_count }}"
          - "Database nodes: {{ database_node_count }}"
          - "Storage nodes: {{ storage_node_count }}"
          - "Monitor nodes: {{ monitor_node_count }}"
          - "Total nodes: {{ manager_node_count + worker_node_count + cache_node_count + database_node_count + storage_node_count + monitor_node_count }}"
          - "========================================"
          - "Next steps:"
          - "  1. Wait 2-3 minutes for droplets to boot"
          - "  2. Run: ansible-playbook deploy.yml"
          - "========================================"
