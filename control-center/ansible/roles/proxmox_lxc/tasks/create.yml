---
# roles/proxmox_lxc/tasks/create.yml
# Create the LXC container using community.general.proxmox.
# This task is idempotent â€” if a container with this VMID already exists
# it will not be recreated.

- name: "Create | Provision LXC container {{ lxc_hostname }} (VMID {{ lxc_vmid }})"
  community.general.proxmox:
    # --- API connection ---
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    validate_certs: false
    node: "{{ proxmox_node_name }}"

    # --- Container identity ---
    vmid: "{{ lxc_vmid }}"
    hostname: "{{ lxc_hostname }}"
    ostemplate: "{{ lxc_template }}"
    password: "{{ lxc_password }}"

    # --- Resources ---
    cores: "{{ lxc_cores }}"
    memory: "{{ lxc_memory }}"
    swap: "{{ lxc_swap }}"
    disk: "{{ lxc_storage }}:{{ lxc_disk_size }}"

    # --- Networking ---
    netif: '{"net0":"{{ _lxc_net_config }}"}'
    nameserver: "{{ lxc_nameserver }}"
    searchdomain: "{{ lxc_searchdomain }}"

    # --- Security ---
    unprivileged: "{{ lxc_unprivileged }}"

    # --- Boot behaviour ---
    onboot: "{{ lxc_onboot }}"

    # --- SSH key injection (written to /root/.ssh/authorized_keys) ---
    pubkey: "{{ _lxc_ssh_public_key }}"

    # --- Features useful inside a container ---
    features:
      - nesting=1

    # --- Desired state ---
    state: present
  delegate_to: "{{ groups['proxmox_hosts'][0] }}"
  register: _lxc_create_result
