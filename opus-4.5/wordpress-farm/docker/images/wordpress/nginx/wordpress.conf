# =============================================================================
# NGINX WORDPRESS SITE CONFIGURATION
# =============================================================================

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /var/www/html;
    index index.php index.html index.htm;

    server_name _;

    # Include security rules
    include /etc/nginx/snippets/security.conf;

    # Include cache rules
    include /etc/nginx/snippets/cache.conf;

    # ==========================================================================
    # HEALTH CHECK ENDPOINT
    # ==========================================================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    location /wp-includes/images/blank.gif {
        access_log off;
        log_not_found off;
    }

    # ==========================================================================
    # MAIN LOCATION
    # ==========================================================================
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ==========================================================================
    # PHP PROCESSING
    # ==========================================================================
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        
        # FastCGI params
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        # Buffer sizes
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        
        # Timeouts
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
        
        # Keep connections alive
        fastcgi_keep_conn on;

        # FastCGI Cache (micro-cache)
        # Skip cache for logged-in users and POST requests
        set $skip_cache 0;

        # POST requests and URLs with query strings
        if ($request_method = POST) {
            set $skip_cache 1;
        }
        if ($query_string != "") {
            set $skip_cache 1;
        }

        # Admin pages, feeds, sitemaps
        if ($request_uri ~* "/wp-admin/|/wp-login.php|/xmlrpc.php|wp-.*.php|/feed/|sitemap(_index)?.xml") {
            set $skip_cache 1;
        }

        # Logged-in users
        if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
            set $skip_cache 1;
        }

        # WooCommerce
        if ($http_cookie ~* "woocommerce_cart_hash|woocommerce_items_in_cart|wp_woocommerce_session") {
            set $skip_cache 1;
        }
        if ($request_uri ~* "/store.*|/cart.*|/my-account.*|/checkout.*|/addons.*|/wc-api.*") {
            set $skip_cache 1;
        }

        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache WORDPRESS;
        fastcgi_cache_valid 200 5m;
        fastcgi_cache_valid 404 1m;

        add_header X-FastCGI-Cache $upstream_cache_status;
    }

    # ==========================================================================
    # WORDPRESS ADMIN
    # ==========================================================================
    location /wp-admin {
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass php-fpm;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
            fastcgi_connect_timeout 300;
            fastcgi_send_timeout 300;
            fastcgi_read_timeout 300;
        }
    }

    # ==========================================================================
    # STATIC FILES
    # ==========================================================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot|otf)$ {
        expires max;
        log_not_found off;
        access_log off;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
    }

    # ==========================================================================
    # ROBOTS & SITEMAP
    # ==========================================================================
    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location ~* ^/sitemap.*\.xml$ {
        try_files $uri /index.php?$args;
    }

    # ==========================================================================
    # DISABLE LOGGING FOR COMMON FILES
    # ==========================================================================
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
}


