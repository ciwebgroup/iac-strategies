# =============================================================================
# ALERTMANAGER CONFIGURATION
# =============================================================================
# Multi-channel alerting: Slack, Email (SendGrid), SMS (Twilio)
# =============================================================================

global:
  resolve_timeout: 5m
  
  # Slack global config
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # SMTP config (SendGrid)
  smtp_smarthost: 'smtp.sendgrid.net:587'
  smtp_from: '${SENDGRID_FROM_EMAIL}'
  smtp_auth_username: 'apikey'
  smtp_auth_password: '${SENDGRID_API_KEY}'
  smtp_require_tls: true

# =============================================================================
# TEMPLATES
# =============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# =============================================================================
# ROUTING
# =============================================================================
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster', 'service', 'tier']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  
  routes:
    # CRITICAL ALERTS - All channels
    - match:
        severity: critical
      receiver: 'critical-all-channels'
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 5m
      continue: true
    
    # WARNING ALERTS - Slack + Email
    - match:
        severity: warning
      receiver: 'warning-slack-email'
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 4h
    
    # INFO ALERTS - Email digest only
    - match:
        severity: info
      receiver: 'info-email-digest'
      group_interval: 24h
      repeat_interval: 168h  # Weekly
    
    # CACHE TIER SPECIFIC - To cache team
    - match:
        tier: cache
      receiver: 'cache-team'
      group_wait: 2m
      continue: true
    
    # DATABASE SPECIFIC - To database team
    - match:
        tier: database
      receiver: 'database-team'
      group_wait: 2m
      continue: true
    
    # SECURITY ALERTS - To security team
    - match_re:
        alertname: '(CrowdSec|SecurityEvent|BruteForce).*'
      receiver: 'security-team'
      group_wait: 1m
      continue: true

# =============================================================================
# RECEIVERS
# =============================================================================
receivers:
  # Default receiver (catch-all)
  - name: 'default'
    slack_configs:
      - channel: '${SLACK_CHANNEL}'
        send_resolved: true
        title: '{{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          {{ end }}

  # CRITICAL - All channels (Slack + Email + SMS)
  - name: 'critical-all-channels'
    slack_configs:
      - channel: '#critical-alerts'
        send_resolved: true
        username: 'WP Farm CRITICAL'
        icon_emoji: ':rotating_light:'
        color: 'danger'
        title: 'üö® CRITICAL ALERT: {{ .GroupLabels.alertname }}'
        text: |
          *Cluster:* {{ .CommonLabels.cluster }}
          *Severity:* CRITICAL
          
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Impact:* {{ .Annotations.impact | default "Service degradation" }}
          *Runbook:* {{ .Annotations.runbook | default "Check Grafana dashboards" }}
          {{ end }}
        actions:
          - type: button
            text: 'View in Grafana'
            url: 'https://grafana.${DOMAIN}'
          - type: button
            text: 'View Logs'
            url: 'https://grafana.${DOMAIN}/explore'
    
    email_configs:
      - to: '${SENDGRID_TO_EMAIL}'
        send_resolved: true
        headers:
          Subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }} - WordPress Farm'
        html: |
          <h2 style="color: #d32f2f;">üö® CRITICAL ALERT</h2>
          <p><strong>Cluster:</strong> {{ .CommonLabels.cluster }}</p>
          <p><strong>Time:</strong> {{ .StartsAt }}</p>
          {{ range .Alerts }}
          <h3>{{ .Annotations.summary }}</h3>
          <p>{{ .Annotations.description }}</p>
          {{ if .Annotations.impact }}<p><strong>Impact:</strong> {{ .Annotations.impact }}</p>{{ end }}
          {{ if .Annotations.runbook }}<p><strong>Runbook:</strong> {{ .Annotations.runbook }}</p>{{ end }}
          {{ end }}
          <p><a href="https://grafana.${DOMAIN}">View Grafana</a></p>
    
    webhook_configs:
      - url: 'http://sms-gateway:5000/webhook'
        send_resolved: false
        http_config:
          bearer_token: '${ALERTMANAGER_WEBHOOK_TOKEN}'

  # WARNING - Slack + Email (no SMS)
  - name: 'warning-slack-email'
    slack_configs:
      - channel: '${SLACK_CHANNEL}'
        send_resolved: true
        username: 'WP Farm Monitoring'
        icon_emoji: ':warning:'
        color: 'warning'
        title: '‚ö†Ô∏è  WARNING: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          {{ end }}
    
    email_configs:
      - to: '${SENDGRID_TO_EMAIL}'
        send_resolved: true
        headers:
          Subject: '‚ö†Ô∏è  WARNING: {{ .GroupLabels.alertname }} - WordPress Farm'

  # INFO - Email digest only
  - name: 'info-email-digest'
    email_configs:
      - to: '${SENDGRID_TO_EMAIL}'
        send_resolved: false
        headers:
          Subject: 'üìä Daily Report: WordPress Farm - {{ .CommonLabels.cluster }}'
        html: |
          <h2>WordPress Farm Daily Report</h2>
          <p><strong>Date:</strong> {{ .StartsAt | date "2006-01-02" }}</p>
          {{ range .Alerts }}
          <h3>{{ .Annotations.summary }}</h3>
          <p>{{ .Annotations.description }}</p>
          {{ end }}

  # Cache team specific
  - name: 'cache-team'
    slack_configs:
      - channel: '#cache-alerts'
        send_resolved: true
        username: 'Cache Monitor'
        icon_emoji: ':package:'
        title: 'Cache Alert: {{ .GroupLabels.alertname }}'
        text: |
          *Tier:* Cache Layer
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Node:* {{ .Labels.instance }}
          {{ end }}

  # Database team specific
  - name: 'database-team'
    slack_configs:
      - channel: '#database-alerts'
        send_resolved: true
        username: 'Database Monitor'
        icon_emoji: ':database:'
        title: 'Database Alert: {{ .GroupLabels.alertname }}'

  # Security team specific
  - name: 'security-team'
    slack_configs:
      - channel: '#security-alerts'
        send_resolved: true
        username: 'Security Monitor'
        icon_emoji: ':shield:'
        color: 'danger'
        title: 'Security Alert: {{ .GroupLabels.alertname }}'

# =============================================================================
# INHIBIT RULES (Prevent Alert Spam)
# =============================================================================
inhibit_rules:
  # Critical alerts suppress warnings for same component
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
  
  # Node down suppresses all other alerts from that node
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']
  
  # Service down suppresses degraded alerts
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: 'ServiceDegraded'
    equal: ['service']

# =============================================================================
# TIME INTERVALS (Optional - Business Hours)
# =============================================================================
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
        - start_time: '09:00'
          end_time: '17:00'
        weekdays: ['monday:friday']
  
  - name: 'off-hours'
    time_intervals:
      - times:
        - start_time: '17:00'
          end_time: '09:00'
      - weekdays: ['saturday', 'sunday']

# =============================================================================
# NOTES
# =============================================================================
# 
# Alert Severity Levels:
# - critical: Service down, user impact, requires immediate action ‚Üí SMS
# - warning: Degraded performance, approaching limits ‚Üí Slack + Email
# - info: Informational, trends, reports ‚Üí Email digest
#
# Testing Alerts:
# curl -H "Content-Type: application/json" -d '[{
#   "labels": {"alertname":"TestAlert","severity":"warning"},
#   "annotations": {"summary":"This is a test alert"}
# }]' http://alertmanager:9093/api/v1/alerts
#
# =============================================================================

