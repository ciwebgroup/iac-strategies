# =============================================================================
# NGINX SECURITY RULES - WordPress
# =============================================================================

# ==========================================================================
# BLOCK SENSITIVE FILES
# ==========================================================================

# Deny access to hidden files (except .well-known)
location ~ /\.(?!well-known) {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to sensitive WordPress files
location ~* ^/(wp-config\.php|readme\.html|license\.txt|xmlrpc\.php)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to .htaccess
location ~ /\.ht {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to wp-includes PHP files directly
location ~* ^/wp-includes/.*\.php$ {
    deny all;
}

# Block access to wp-content/uploads PHP files
location ~* ^/wp-content/uploads/.*\.php$ {
    deny all;
}

# Block access to wp-content/plugins/wp-content PHP files (theme-check false positives)
location ~* ^/wp-content/plugins/.*\.php$ {
    # Allow normal plugin PHP execution
    try_files $uri =404;
}

# ==========================================================================
# BLOCK COMMON EXPLOITS
# ==========================================================================

# Block access to debug logs
location ~* \.(log|txt|md)$ {
    deny all;
}

# Block access to backup files
location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$ {
    deny all;
}

# Block access to version control
location ~ /\.(svn|git|hg|bzr) {
    deny all;
}

# ==========================================================================
# BLOCK BAD BOTS
# ==========================================================================
if ($http_user_agent ~* (mj12bot|ahrefs|semrush|dotbot|rogerbot|gigabot|webzip|wget|nikto|sqlmap|nmap)) {
    return 403;
}

# ==========================================================================
# BLOCK COMMON SQL INJECTION PATTERNS
# ==========================================================================
location ~* "(eval\()" { return 403; }
location ~* "(base64_encode)" { return 403; }
location ~* "(GLOBALS|REQUEST)(=|\[|%)" { return 403; }
location ~* "(<|%3C).*script.*(>|%3E)" { return 403; }
location ~* "(boot\.ini|etc/passwd|self/environ)" { return 403; }
location ~* "(thumbs?(_tele498telerik\.telerik\.\.axd)" { return 403; }
location ~* "(https?|ftp|php):/" { return 403; }

# ==========================================================================
# WORDPRESS-SPECIFIC PROTECTION
# ==========================================================================

# Block author enumeration
if ($args ~* "^author=\d+") {
    return 403;
}

# Block wp-cron.php abuse (should be triggered via server cron)
location = /wp-cron.php {
    # Allow internal requests only
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    
    fastcgi_pass php-fpm;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# Block wp-trackback.php
location = /wp-trackback.php {
    deny all;
}

# Limit wp-login.php requests
location = /wp-login.php {
    limit_req zone=login burst=3 nodelay;
    
    fastcgi_pass php-fpm;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# ==========================================================================
# RATE LIMITING ZONES (defined in nginx.conf http block)
# ==========================================================================
# Add this to nginx.conf http block:
# limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
# limit_req_zone $binary_remote_addr zone=xmlrpc:10m rate=1r/m;


