# =============================================================================
# NGINX CACHE RULES - WordPress
# =============================================================================

# ==========================================================================
# STATIC FILE CACHING
# ==========================================================================

# Media files
location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc|webp|avif)$ {
    expires 1M;
    access_log off;
    add_header Cache-Control "public, immutable";
    add_header Vary Accept-Encoding;
}

# CSS and JavaScript
location ~* \.(?:css|js)$ {
    expires 1y;
    access_log off;
    add_header Cache-Control "public, immutable";
    add_header Vary Accept-Encoding;
}

# Fonts
location ~* \.(?:ttf|ttc|otf|eot|woff|woff2)$ {
    expires 1M;
    access_log off;
    add_header Cache-Control "public";
    add_header Access-Control-Allow-Origin *;
}

# ==========================================================================
# OPEN FILE CACHE
# ==========================================================================
open_file_cache max=10000 inactive=20s;
open_file_cache_valid 30s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

# ==========================================================================
# PROXY CACHE HEADERS (for upstream Varnish)
# ==========================================================================
# These headers help Varnish make caching decisions

# Tell Varnish to cache this content
map $request_uri $cache_control {
    default                              "public, max-age=300";
    ~*^/wp-admin                         "no-store, no-cache, must-revalidate, proxy-revalidate";
    ~*^/wp-login                         "no-store, no-cache, must-revalidate, proxy-revalidate";
    ~*^/wp-cron                          "no-store, no-cache, must-revalidate, proxy-revalidate";
    ~*\.(xml|json)$                      "public, max-age=60";
}

# ==========================================================================
# CACHE BYPASS CONDITIONS
# ==========================================================================
# Set header for upstream to determine cacheability
map $http_cookie $bypass_cache {
    default 0;
    ~*wordpress_logged_in 1;
    ~*comment_author 1;
    ~*wp-postpass 1;
    ~*woocommerce_cart_hash 1;
    ~*woocommerce_items_in_cart 1;
}


