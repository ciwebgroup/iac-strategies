# =============================================================================
# REDIS CONFIGURATION - WordPress Object Cache
# =============================================================================
# Optimized for: WordPress object caching
# Mode: Master-Replica with Sentinel
# =============================================================================

# Bind to all interfaces (Docker network)
bind 0.0.0.0

# Port
port 6379

# Protected mode off (using password auth + Docker network isolation)
protected-mode no

# TCP backlog
tcp-backlog 511

# Timeout
timeout 300

# TCP keepalive
tcp-keepalive 300

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Maximum memory
maxmemory 2gb

# Eviction policy: Remove least recently used keys
maxmemory-policy allkeys-lru

# Number of samples for LRU algorithm
maxmemory-samples 5

# =============================================================================
# PERSISTENCE
# =============================================================================

# Save database to disk
save 900 1       # After 900 sec (15 min) if at least 1 key changed
save 300 10      # After 300 sec (5 min) if at least 10 keys changed
save 60 10000    # After 60 sec if at least 10000 keys changed

# Stop writes if background save fails
stop-writes-on-bgsave-error yes

# Compress string objects using LZF
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# Database filename
dbfilename dump.rdb

# Working directory
dir /data

# =============================================================================
# REPLICATION
# =============================================================================

# Replica read-only mode
replica-read-only yes

# Replication diskless sync (faster)
repl-diskless-sync yes

# Diskless sync delay
repl-diskless-sync-delay 5

# Disable TCP_NODELAY on replica socket (better for bulk transfer)
repl-disable-tcp-nodelay no

# Replica priority
replica-priority 100

# Min replicas to accept writes (ensure data safety)
min-replicas-to-write 0  # 0 = don't block writes if no replicas

# =============================================================================
# SECURITY
# =============================================================================

# Require password for all operations
# Note: Password set via command line, not here (for security)
# requirepass ${REDIS_PASSWORD}

# Rename dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG "CONFIG-$(openssl rand -hex 8)"
rename-command DEBUG ""

# =============================================================================
# CLIENTS
# =============================================================================

# Max number of client connections
maxclients 10000

# =============================================================================
# SLOW LOG
# =============================================================================

# Slow log threshold (microseconds)
slowlog-log-slower-than 10000  # 10ms

# Slow log length
slowlog-max-len 128

# =============================================================================
# ADVANCED CONFIG
# =============================================================================

# Hash max entries
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List max size
list-max-ziplist-size -2

# Set max entries
set-max-intset-entries 512

# Sorted set max entries
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog sparse representation
hll-sparse-max-bytes 3000

# Streams max entries
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of background tasks
hz 10

# Dynamic HZ
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

# =============================================================================
# MONITORING
# =============================================================================

# Latency monitor (track slow operations)
latency-monitor-threshold 100  # 100ms

# =============================================================================
# NOTES
# =============================================================================
#
# WordPress Integration:
# - Use wp-redis or Redis Object Cache plugin
# - Configure WordPress to connect to redis-master:6379
# - Set password via WP_REDIS_PASSWORD constant
#
# Monitoring:
# redis-cli -a $REDIS_PASSWORD INFO stats
# redis-cli -a $REDIS_PASSWORD CLIENT LIST
# redis-cli -a $REDIS_PASSWORD SLOWLOG GET 10
#
# Memory Usage Check:
# redis-cli -a $REDIS_PASSWORD INFO memory
#
# Performance Tuning:
# - Adjust maxmemory based on available RAM
# - Monitor eviction rate
# - Adjust maxmemory-policy if needed
# - Consider disabling persistence for pure cache (comment out save lines)
#
# =============================================================================

